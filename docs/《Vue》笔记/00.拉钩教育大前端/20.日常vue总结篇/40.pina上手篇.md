## åŸºæœ¬ç”¨æ³•ç¯‡

> åŒæ—¶æ”¯æŒ Composition Api å’Œ Options api çš„è¯­æ³•ï¼›
>
> å»æ‰ mutations ï¼Œåªæœ‰ state ã€getters å’Œ actions ï¼›
>
> ä¸æ”¯æŒåµŒå¥—çš„æ¨¡å—ï¼Œé€šè¿‡ç»„åˆ store æ¥ä»£æ›¿ï¼›
>
> æ›´å®Œå–„çš„ Typescript æ”¯æŒï¼›
>
> æ¸…æ™°ã€æ˜¾å¼çš„ä»£ç æ‹†åˆ†ã€‚

[Piniaçš„ä½¿ç”¨ä»¥åŠæ•°æ®æŒä¹…åŒ–](https://juejin.cn/post/7101657189428756516)

[æ–°ä¸€ä»£çŠ¶æ€ç®¡ç†å·¥å…·ï¼ŒPinia.js ä¸Šæ‰‹æŒ‡å—](https://juejin.cn/post/7049196967770980389)

[ä¸€ä¸ªç™»å½•æ¡ˆä¾‹åŒ…å­¦ä¼š Pinia](https://juejin.cn/post/7154579554034515982)

[å¤§è èï¼è¿™ä¸€æ¬¡å½»åº•ææ‡‚Piniaï¼ï¼ˆä¿å§†çº§æ•™ç¨‹ï¼‰](https://juejin.cn/post/7112691686085492767)

### piniaä½¿ç”¨

ä»¥ `Vue3 + TypeScript` ä¸ºä¾‹

å®‰è£…

```js
npm install pinia
```

`main.ts` åˆå§‹åŒ–é…ç½®

```js
import { createPinia } from 'pinia'
createApp(App).use(createPinia()).mount('#app')
```

åœ¨ store ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `user.ts` ä¸ºä¾‹ï¼Œæˆ‘ä»¬å…ˆå®šä¹‰å¹¶å¯¼å‡ºä¸€ä¸ªåä¸º `user` çš„æ¨¡å—

```js
import { defineStore } from 'pinia'
export const userStore = defineStore('user', {
    state: () => {
        return { 
            count: 1,
            arr: []
        }
    },
    getters: { ... },
    actions: { ... }
})
```

`defineStore` æ¥æ”¶ä¸¤ä¸ªå‚æ•°

ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯æ¨¡å—çš„åç§°ï¼Œå¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œå¤šä¸ªæ¨¡å—ä¸èƒ½é‡åï¼ŒPinia ä¼šæŠŠæ‰€æœ‰çš„æ¨¡å—éƒ½æŒ‚è½½åˆ°æ ¹å®¹å™¨ä¸Š
 ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé‡Œé¢çš„é€‰é¡¹å’Œ Vuex å·®ä¸å¤š

- å…¶ä¸­ `state` ç”¨æ¥å­˜å‚¨å…¨å±€çŠ¶æ€ï¼Œå®ƒå¿…é¡»æ˜¯ç®­å¤´å‡½æ•°ï¼Œä¸ºäº†åœ¨æœåŠ¡ç«¯æ¸²æŸ“çš„æ—¶å€™é¿å…äº¤å‰è¯·æ±‚å¯¼è‡´çš„æ•°æ®çŠ¶æ€æ±¡æŸ“æ‰€ä»¥åªèƒ½æ˜¯å‡½æ•°ï¼Œè€Œå¿…é¡»ç”¨ç®­å¤´å‡½æ•°åˆ™ä¸ºäº†æ›´å¥½çš„ TS ç±»å‹æ¨å¯¼
- `getters` å°±æ˜¯ç”¨æ¥å°è£…è®¡ç®—å±æ€§ï¼Œå®ƒæœ‰ç¼“å­˜çš„åŠŸèƒ½
- `actions` å°±æ˜¯ç”¨æ¥å°è£…ä¸šåŠ¡é€»è¾‘ï¼Œä¿®æ”¹ state

##### é…ç½®store.js

```js
import { defineStore } from 'pinia'

// defineStore è°ƒç”¨åè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè°ƒç”¨è¯¥å‡½æ•°è·å¾— Store å®ä½“
export const useStore = defineStore({
  // id: å¿…é¡»ï¼Œåœ¨æ‰€æœ‰ Store ä¸­å”¯ä¸€
  id: 'globalState',
  // state: è¿”å›å¯¹è±¡çš„å‡½æ•°
  state: () => ({
    count: 1,
    data: {
      name: 'Jerry',
      sex: 'ç”·'
    }
  }),
  // getter ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ stateï¼Œæ˜¯å½“å‰çš„çŠ¶æ€ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ this è·å–çŠ¶æ€
  // getter ä¸­ä¹Ÿå¯ä»¥è®¿é—®å…¶ä»–çš„ getterï¼Œæˆ–è€…æ˜¯å…¶ä»–çš„ Store
  getters: {
    // é€šè¿‡ state è·å–çŠ¶æ€
    doubleCount: (state) => state.count * 2,
    // é€šè¿‡ this è·å–çŠ¶æ€ï¼ˆæ³¨æ„thisæŒ‡å‘ï¼‰
    tripleCount() {
      return this.count * 3
    }
  },
  actions: {
    updateData (newData, count) {
      // ä½¿ç”¨ this ç›´æ¥ä¿®æ”¹
      this.data = { ...newData }
      this.count = count
      
      // ä½¿ç”¨ $patch ä¿®æ”¹å¤šä¸ªå€¼
      this.$patch({
        data: { ...newData },
        count
      })
    }
  }
})

```

##### ä½¿ç”¨store

```js
<template>
  // è·å– store çš„ state
  <p>å§“åï¼š{{store.data.name}}</p>
  <p>æ€§åˆ«ï¼š{{store.data.sex}}</p>
  
  // è°ƒç”¨ actions æ–¹æ³• / ä¿®æ”¹ store
  <button @click='update'>ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯</button>
  
  // è·å– getter
  <p>è·å–getterï¼š{{store.doubleCount}}</p>
</template>

<script setup>
  import { useStore } from '@store/store.js'
  const store = useStore()
  
  function update () {
    // é€šè¿‡ actions å®šä¹‰çš„æ–¹æ³•ä¿®æ”¹ state
    store.updateData({ name: 'Tom', sex: 'å¥³' })
    
    // é€šè¿‡ store ç›´æ¥ä¿®æ”¹
    store.data = { name: 'Tom', sex: 'å¥³' }
    
    // åŒæ—¶æ”¹å˜å¤šä¸ªçŠ¶æ€
    store.$patch((state) => {
      state.data = { name: 'Tom', sex: 'å¥³' }
      state.count = 2
    })
  }
</script>

<style lang="scss" scoped>
</style>

```

##### å…¶ä»–æ–¹æ³•

**æ›¿æ¢æ•´ä¸ª state** 
 `$state` å¯ä»¥è®©ä½ é€šè¿‡å°† `store` çš„å±æ€§è®¾ç½®ä¸ºæ–°å¯¹è±¡æ¥æ›¿æ¢ `store` çš„æ•´ä¸ª `state`

```javascript
const store = useStore()
store.$state = {
  name: 'Bob',
  sex: 'ç”·'
}
```

**é‡ç½®çŠ¶æ€** 
 è°ƒç”¨ `store` ä¸Šçš„ `$reset()` æ–¹æ³•å°†çŠ¶æ€é‡ç½®ä¸ºåˆå§‹å€¼

```javascript
const store = useStore()
store.$reset()
```



#### åœ¨setupä¸­ä½¿ç”¨store

è¿™é‡Œä»‹ç»ä¸€ä¸‹åœ¨Composition APIä¸­å¦‚ä½•ä½¿ç”¨storeã€‚æ”¯æŒsetupè¯­æ³•ç³–ã€‚

ç±»ä¼¼Vuexä¸­çš„useStoreå‡½æ•°ï¼ŒPiniaä¹Ÿæä¾›äº†ç›¸ä¼¼çš„ç”¨æ³•ï¼Œåœ¨ç»„ä»¶çš„scriptæ ‡ç­¾ä¸­å¯¼å…¥æˆ‘ä»¬è‡ªå®šä¹‰çš„Storeå‡½æ•°ï¼Œè°ƒç”¨åèµ‹å€¼ç»™ç›¸åº”çš„å˜é‡å³å¯ã€‚stateå’Œgetterséƒ½èƒ½ç›´æ¥è®¿é—®ï¼Œå¯ä»¥ä½¿ç”¨computedä½¿è¢«èµ‹å€¼çš„å˜é‡å˜ä¸ºå“åº”å¼ã€‚

```js
// xxx.vue

import { ref, computed, defineComponent } from "vue";
import { useUserStore } from "@/store/userStore";
export default defineComponent({
  setup() {
    const userStore = useUserStore(),
      // state
      username = computed(() => userStore.username),
      // ä½¿ç”¨computed, åˆ™passwordæˆä¸ºäº†å“åº”å¼æ•°æ®ï¼Œè€Œusernameä¸æ˜¯ã€‚
      password = computed(() => userStore.password),
      // getters
      authority = computed(() => userSore.authorityLevel)
    return {
      username,
      password,
      authority
    }
  }
})
```

#### åœ¨setupå¤–é¢ä½¿ç”¨store

éœ€è¦æ³¨æ„useStoreä½¿ç”¨çš„æ—¶æœºï¼Œ**éœ€è¦åœ¨appæŒ‚è½½piniaä¹‹åæ‰èƒ½ä½¿ç”¨**ï¼Œä»¥åœ¨è·¯ç”±å®ˆå«ä¸­ä¸ºä¾‹ï¼š

```js
// src/router/index.ts

// ! æ— æ•ˆï¼Œä¼šæŠ¥é”™è¿˜æœªå®‰è£…pinia
// const userStore = useUserStore();

router.beforeEach((to, from, next) => {
  // æœ‰æ•ˆ, æ­¤æ—¶vueå·²ç»æŒ‚è½½äº†routerï¼Œåˆ™ä¹ŸæŒ‚è½½äº†pinia
  const userStore = useUserStore();
  to.path === "/about" && userStore.role === "" && next("/login");
  next();
});
```



#### getters

è¿™ä¸ªå’Œ Vuex çš„ getters ä¸€æ ·ï¼Œä¹Ÿæœ‰ç¼“å­˜åŠŸèƒ½ã€‚å¦‚ä¸‹åœ¨é¡µé¢ä¸­å¤šæ¬¡ä½¿ç”¨ï¼Œç¬¬ä¸€æ¬¡ä¼šè°ƒç”¨ gettersï¼Œæ•°æ®æ²¡æœ‰æ”¹å˜çš„æƒ…å†µä¸‹ä¹‹åä¼šè¯»å–ç¼“å­˜

```html
<template>
    <div>{{ myCount }}</div>
    <div>{{ myCount }}</div>
    <div>{{ myCount }}</div>
</template>
```

æ³¨æ„ä¸¤ç§æ–¹æ³•çš„åŒºåˆ«ï¼Œå†™åœ¨æ³¨é‡Šé‡Œäº†

```js
getters: {
    // æ–¹æ³•ä¸€ï¼Œæ¥æ”¶ä¸€ä¸ªå¯é€‰å‚æ•° state
    myCount(state){
        console.log('è°ƒç”¨äº†') // é¡µé¢ä¸­ä½¿ç”¨äº†ä¸‰æ¬¡ï¼Œè¿™é‡Œåªä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œç„¶åç¼“å­˜èµ·æ¥äº†
        return state.count + 1
    },
    // æ–¹æ³•äºŒï¼Œä¸ä¼ å‚æ•°ï¼Œä½¿ç”¨ this
    // ä½†æ˜¯å¿…é¡»æŒ‡å®šå‡½æ•°è¿”å›å€¼çš„ç±»å‹ï¼Œå¦åˆ™ç±»å‹æ¨å¯¼ä¸å‡ºæ¥
    myCount(): number{
        return this.count + 1
    }
}
```

#### æ›´æ–°å’Œactions

æ›´æ–° state é‡Œçš„æ•°æ®æœ‰å››ç§æ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‰ç§ç®€å•çš„æ›´æ–°ï¼Œè¯´æ˜éƒ½å†™åœ¨æ³¨é‡Šé‡Œäº†

```js
<template>
    <div>{{ user_store.count }}</div>
    <button @click="handleClick">æŒ‰é’®</button>
</template>
<script lang="ts" setup>
import { userStore } from '../store'
const user_store = userStore()
const handleClick = () => {
    // æ–¹æ³•ä¸€
    user_store.count++
    
    // æ–¹æ³•äºŒï¼Œéœ€è¦ä¿®æ”¹å¤šä¸ªæ•°æ®ï¼Œå»ºè®®ç”¨ $patch æ‰¹é‡æ›´æ–°ï¼Œä¼ å…¥ä¸€ä¸ªå¯¹è±¡
    user_store.$patch({
        count: user_store.count1++,
        // arr: user_store.arr.push(1) // é”™è¯¯
        arr: [ ...user_store.arr, 1 ] // å¯ä»¥ï¼Œä½†æ˜¯è¿˜å¾—æŠŠæ•´ä¸ªæ•°ç»„éƒ½æ‹¿å‡ºæ¥è§£æ„ï¼Œå°±æ²¡å¿…è¦
    })
    
    // ä½¿ç”¨ $patch æ€§èƒ½æ›´ä¼˜ï¼Œå› ä¸ºå¤šä¸ªæ•°æ®æ›´æ–°åªä¼šæ›´æ–°ä¸€æ¬¡è§†å›¾
    
    // æ–¹æ³•ä¸‰ï¼Œè¿˜æ˜¯$patchï¼Œä¼ å…¥å‡½æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ state
    user_store.$patch( state => {
        state.count++
        state.arr.push(1)
    })
}
</script>
```

ç¬¬å››ç§æ–¹æ³•å°±æ˜¯å½“é€»è¾‘æ¯”è¾ƒå¤šæˆ–è€…è¯·æ±‚çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°è£…åˆ°ç¤ºä¾‹ä¸­ store/user.ts é‡Œçš„ actions é‡Œ

å¯ä»¥ä¼ å‚æ•°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ this.xx å¯ä»¥ç›´æ¥è·å–åˆ° state é‡Œçš„æ•°æ®ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä¸èƒ½ç”¨ç®­å¤´å‡½æ•°å®šä¹‰ actionsï¼Œä¸ç„¶å°±ä¼šç»‘å®šå¤–éƒ¨çš„ this äº†

```js
actions: {
    changeState(num: number){ // ä¸èƒ½ç”¨ç®­å¤´å‡½æ•°
        this.count += num
    }
}
```

è°ƒç”¨

```js
const handleClick = () => {
    user_store.changeState(1)
}
```





#### å°ç»“

1. å®‰è£…: å¯ä½¿ç”¨npmæˆ–yarnå®‰è£…ï¼Œæ³¨æ„åˆ›å»ºé¡¹ç›®æ—¶ä¸é€‰vuexã€‚
2. æŒ‚è½½: åœ¨main.jsä¸­åˆ›å»ºå¹¶æŒ‚è½½piniaã€‚
3. å®šä¹‰: åœ¨store/myStore.jsä¸­å¯¼å…¥å¹¶ä½¿ç”¨defineStoreæ¥å®šä¹‰storeï¼Œä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸ºstoreIdï¼Œå¹¶åˆå§‹åŒ–stateï¼Œgettersï¼Œactionsï¼Œå¯¼å‡ºuseMyStoreå‡½æ•°ã€‚
4. state

- stateæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œç±»ä¼¼options APIä¸­çš„data;
- ä¿®æ”¹stateçš„è¡Œä¸ºæˆä¸ºmutationï¼ŒPiniaä¸­æ²¡æœ‰mutationé€‰é¡¹ï¼Œä½†æ˜¯æœ‰å¤šç§ä¿®æ”¹stateçš„æ–¹å¼ã€‚
  - ç›´æ¥åœ¨setupä¸­è®¿é—®storeå®ä¾‹çš„å±æ€§å¹¶ä¿®æ”¹ã€‚mutationç±»å‹å±äº'direct'
  - åœ¨actionsä¸­é€šè¿‡thisè®¿é—®å¹¶ä¿®æ”¹stateçš„å±æ€§ï¼Œå¹¶åœ¨setupä¸­è°ƒç”¨ç›¸åº”çš„actionå³å¯ã€‚mutationç±»å‹å±äº'direct'
  - åœ¨setupä¸­é€šè¿‡storeå®ä¾‹çš„$patch()ï¼Œä¼ å…¥ä¸€ä¸ªå¯¹è±¡æ¥å±€éƒ¨ä¿®æ”¹stateã€‚mutationç±»å‹å±äº'patch object'
  - åœ¨setupä¸­é€šè¿‡storeå®ä¾‹çš„$patch()ï¼Œä¼ å…¥ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°è¿”å›ä¸€ä¸ªå¯¹è±¡æ¥å±€éƒ¨ä¿®æ”¹stateã€‚mutationç±»å‹å±äº'patch function'
  - åœ¨setupä¸­é€šè¿‡storeå®ä¾‹çš„$stateæ¥æ•´ä½“é‡è®¾stateï¼Œä¼ å…¥ä¸€ä¸ªæ–°çš„å¯¹è±¡ä½œä¸ºæ–°çš„stateçš„æ•°æ®ï¼Œæ­¤æ—¶ä¼ å…¥çš„å¯¹è±¡éœ€åŒ…å«stateçš„å…¨éƒ¨å±æ€§ã€‚mutationç±»å‹å±äº'patch function'
- ä¾¦å¬stateçš„å˜åŒ–ï¼šé€šè¿‡storeå®ä¾‹çš„$subscribeæ–¹æ³•æ¥ç›‘æµ‹stateçš„å˜åŒ–ï¼Œæ¥æ”¶ä¸€ä¸ªcallbackï¼Œcallbackæœ‰mutationå’Œstateä¸¤ä¸ªå‚æ•°ã€‚å…¶ä¸­mutationåŒ…å«ä¿®æ”¹stateçš„ä¿¡æ¯ï¼Œstateå‚æ•°ä¸ºä¿®æ”¹åçš„stateï¼Œå¯ä»¥åœ¨æ­¤å¤„å¯¹stateè¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨ç­‰æ“ä½œã€‚

**getters**

- gettersç±»ä¼¼vueçš„computedï¼Œgettersä¾èµ–äºstateä¸”å…·æœ‰ç¼“å­˜æ•ˆæœï¼Œæ¥æ”¶stateä½œä¸ºå‚æ•°ï¼Œä¸”é€šè¿‡stateè®¿é—®å…¶å±æ€§
- getterså¯ä»¥é€šè¿‡thisè®¿é—®æœ¬storeå®ä¾‹ä¸­çš„å…¶å®ƒgetters
- gettersé‡Œå¯ä»¥è®¿é—®å…¶å®ƒstoreå®ä¾‹çš„getterså’Œstateï¼Œéœ€è¦å¯¼å…¥å…¶å®ƒçš„store
- getterså¯ä»¥é€šè¿‡è¿”å›ä¸€ä¸ªå‡½æ•°çš„æ–¹å¼æ¥å®ç°æ¥æ”¶å‚æ•°ï¼Œä½†æ­¤æ—¶å®ƒä¼šå¤±å»ç¼“å­˜æ•ˆæœ

**actions**

- ç±»ä¼¼vueä¸­çš„methodsï¼Œå¯ä»¥ä¿®æ”¹stateçš„å€¼ï¼Œå¯ä»¥è¿›è¡Œå¼‚æ­¥æ“ä½œ
- å¯ä»¥é€šè¿‡thisè®¿é—®æœ¬storeå®ä¾‹çš„gettersã€actionsç­‰
- å¯ä»¥è°ƒç”¨å…¶å®ƒstoreé‡Œçš„actionsï¼Œéœ€è¦å¯¼å…¥å…¶å®ƒçš„store

**åœ¨setupä¸­è®¿é—®store**

å¯¼å…¥useMyStoreå‡½æ•°å¹¶å®ä¾‹åŒ–storeï¼Œå³å¯è®¿é—®å…¶stateï¼Œgettersï¼Œä»¥åŠè°ƒç”¨actionsæˆ–å…¶å®ƒAPIã€‚

**åœ¨è·¯ç”±å®ˆå«ä¸­ä½¿ç”¨store**

éœ€è¦åœ¨è·¯ç”±é’©å­å‡½æ•°ï¼ˆå¦‚beforEachï¼‰å†…éƒ¨ä½¿ç”¨ï¼Œæ­¤æ—¶piniaå·²æˆåŠŸæŒ‚è½½åˆ°appå®ä¾‹ä¸Šã€‚è‹¥åœ¨è·¯ç”±é’©å­å‡½æ•°å¤–éƒ¨ä½¿ç”¨ï¼Œåˆ™ä¼šæŠ¥é”™ï¼Œæç¤ºpiniaæœªæ­£ç¡®å®‰è£…ã€‚

## Piniaè¿›é˜¶ç¯‡

### Piniaä¸Vuexä»£ç åˆ†å‰²æœºåˆ¶

ä¸Šè¿°çš„Piniaè½»é‡æœ‰ä¸€éƒ¨åˆ†ä½“ç°åœ¨å®ƒçš„ä»£ç åˆ†å‰²æœºåˆ¶ä¸­ã€‚

> ä¸¾ä¸ªä¾‹å­ï¼šæŸé¡¹ç›®æœ‰**3ä¸ªstoreã€Œuserã€jobã€payã€**ï¼Œå¦å¤–æœ‰**2ä¸ªè·¯ç”±é¡µé¢ã€Œé¦–é¡µã€ä¸ªäººä¸­å¿ƒé¡µã€**ï¼Œ**é¦–é¡µç”¨åˆ°job storeï¼Œä¸ªäººä¸­å¿ƒé¡µç”¨åˆ°äº†user store**ï¼Œåˆ†åˆ«ç”¨Piniaå’ŒVuexå¯¹å…¶çŠ¶æ€ç®¡ç†ã€‚

![image-20230618163349756](https://cdn.jsdelivr.net/gh/citccld/blogimage@main/img/202306181633943.png)



**å…ˆçœ‹Vuexçš„ä»£ç åˆ†å‰²ï¼š** æ‰“åŒ…æ—¶ï¼Œvuexä¼šæŠŠ3ä¸ªstoreåˆå¹¶æ‰“åŒ…ï¼Œå½“é¦–é¡µç”¨åˆ°Vuexæ—¶ï¼Œè¿™ä¸ªåŒ…ä¼šå¼•å…¥åˆ°é¦–é¡µä¸€èµ·æ‰“åŒ…ï¼Œæœ€åè¾“å‡º1ä¸ªjs chunkã€‚è¿™æ ·çš„é—®é¢˜æ˜¯ï¼Œå…¶å®é¦–é¡µåªéœ€è¦å…¶ä¸­1ä¸ªstoreï¼Œä½†å…¶ä»–2ä¸ªæ— å…³çš„storeä¹Ÿè¢«æ‰“åŒ…è¿›æ¥ï¼Œé€ æˆèµ„æºæµªè´¹ã€‚

![image-20230618163410558](https://cdn.jsdelivr.net/gh/citccld/blogimage@main/img/202306181634721.png)

**Piniaçš„ä»£ç åˆ†å‰²ï¼š** æ‰“åŒ…æ—¶ï¼ŒPiniaä¼šæ£€æŸ¥å¼•ç”¨ä¾èµ–ï¼Œå½“é¦–é¡µç”¨åˆ°job storeï¼Œæ‰“åŒ…åªä¼šæŠŠç”¨åˆ°çš„storeå’Œé¡µé¢åˆå¹¶è¾“å‡º1ä¸ªjs chunkï¼Œå…¶ä»–2ä¸ªstoreä¸è€¦åˆåœ¨å…¶ä¸­ã€‚Piniaèƒ½åšåˆ°è¿™ç‚¹ï¼Œæ˜¯å› ä¸ºå®ƒçš„è®¾è®¡å°±æ˜¯storeåˆ†ç¦»çš„ï¼Œè§£å†³äº†é¡¹ç›®çš„è€¦åˆé—®é¢˜ã€‚

### Piniaçš„å¸¸è§„ç”¨æ³•

äº‹ä¸å®œè¿Ÿï¼Œç›´æ¥å¼€å§‹ä½¿ç”¨`Pinia`ã€Œæœ¬æ–‡é»˜è®¤ä½¿ç”¨Vue3çš„setup Composition APIå¼€å‘æ¨¡å¼ã€ã€‚

> **å‡å¦‚ä½ å¯¹Piniaä½¿ç”¨ç†Ÿæ‚‰ï¼Œå¯ä»¥ç•¥è¿‡è¿™partğŸ‘»**

#### 1. å®‰è£…

```bash
yarn add pinia
# or with npm
npm install pinia
```

#### 2. æŒ‚è½½å…¨å±€å®ä¾‹

```typescript
import { createPinia } from 'pinia'

app.use(createPinia())
```

#### 3. åˆ›å»ºç¬¬ä¸€ä¸ªstore

åœ¨`src/store/counterForOptions.ts`åˆ›å»ºä½ çš„storeã€‚å®šä¹‰storeæ¨¡å¼æœ‰2ç§ï¼š

- ä½¿ç”¨options APIæ¨¡å¼å®šä¹‰ï¼Œè¿™ç§æ–¹å¼å’Œvue2çš„ç»„ä»¶æ¨¡å‹å½¢å¼ç±»ä¼¼ï¼Œä¹Ÿæ˜¯å¯¹vue2æŠ€æœ¯æ ˆå¼€å‘è€…è¾ƒä¸ºå‹å¥½çš„ç¼–ç¨‹æ¨¡å¼ã€‚

  ```typescript
  import { defineStore } from 'pinia';
  
  // ä½¿ç”¨options APIæ¨¡å¼å®šä¹‰
  export const useCounterStoreForOption = defineStore('counterForOptions', {
    // å®šä¹‰state
    state: () => {
      return { count1: 1 };
    },
    // å®šä¹‰action
    actions: {
      increment() {
        this.count1++;
      }
    },
    // å®šä¹‰getters
    getters: {
      doubleCount(state) {
        return state.count1 * 2;
      }
    }
  });
  ```

- ä½¿ç”¨setupæ¨¡å¼å®šä¹‰ï¼Œç¬¦åˆVue3 setupçš„ç¼–ç¨‹æ¨¡å¼ï¼Œè®©ç»“æ„æ›´åŠ æ‰å¹³åŒ–ï¼Œä¸ªäººæ¨èæ¨èä½¿ç”¨è¿™ç§æ–¹å¼ã€‚

  ```typescript
  import { ref } from 'vue';
  import { defineStore } from 'pinia';
  
  // ä½¿ç”¨setupæ¨¡å¼å®šä¹‰
  export const useCounterStoreForSetup = defineStore('counterForSetup', () => {
    const count = ref<number>(1);
    function increment() {
      count.value++;
    }
  
    function doubleCount() {
      return count.value * 2;
    }
  
    return { count, increment, doubleCount };
  });
  ```

ä¸Šé¢2ç§å®šä¹‰æ–¹å¼æ•ˆæœéƒ½æ˜¯ä¸€æ ·çš„ï¼Œæˆ‘ä»¬ç”¨`defineStore`æ–¹æ³•å®šä¹‰ä¸€ä¸ªstoreï¼Œé‡Œé¢åˆ†åˆ«å®šä¹‰1ä¸ª`count`çš„stateï¼Œ1ä¸ª`increment` action å’Œ1ä¸ª`doubleCount`çš„gettersã€‚å…¶ä¸­stateæ˜¯è¦å…±äº«çš„å…¨å±€çŠ¶æ€ï¼Œè€Œactionåˆ™æ˜¯è®©ä¸šåŠ¡æ–¹è°ƒç”¨æ¥æ”¹å˜stateçš„å…¥å£ï¼Œgettersæ˜¯è·å–stateçš„è®¡ç®—ç»“æœã€‚

ä¹‹æ‰€ä»¥ç”¨ç¬¬ä¸€ç§æ–¹å¼å®šä¹‰æ˜¯è¿˜è¦é¢å¤–å†™`getters`ã€`action`å…³é”®å­—æ¥åŒºåˆ†ï¼Œæ˜¯å› ä¸ºåœ¨options APIæ¨¡å¼ä¸‹å¯ä»¥é€šè¿‡[`mapState()`ã€`mapActions()`](https://link.juejin.cn?target=https%3A%2F%2Fpinia.vuejs.org%2Fcore-concepts%2Fstate.html%23usage-with-the-options-api)ç­‰æ–¹æ³•è·å–å¯¹åº”é¡¹ï¼›ä½†ç¬¬äºŒç§æ–¹å¼å°±å¯ä»¥ç›´æ¥è·å–äº†ï¼ˆä¸‹é¢ä¼šç»†è¿°ï¼‰ã€‚

#### 4. ä¸šåŠ¡ç»„ä»¶å¯¹storeçš„è°ƒç”¨

åœ¨`src/components/PiniaBasicSetup.vue`ç›®å½•ä¸‹åˆ›å»ºä¸ªç»„ä»¶ã€‚

```typescript
<script setup lang="ts" name="component-PiniaBasicSetup">
import { storeToRefs } from 'pinia';
import { useCounterStoreForSetup } from '@/store/counterForSetup';

// setup composition APIæ¨¡å¼
const counterStoreForSetup = useCounterStoreForSetup();
const { count } = storeToRefs(counterStoreForSetup);
const { increment, doubleCount } = counterStoreForSetup;
</script>

<template>
  <div class="box-styl">
    <h1>Setupæ¨¡å¼</h1>
    <p class="section-box">
      Piniaçš„state: count = <b>{{ count }}</b>
    </p>
    <p class="section-box">
      Piniaçš„getters: doubleCount() = <b>{{ doubleCount() }}</b>
    </p>
    <div class="section-box">
      <p>Piniaçš„action: increment()</p>
      <button @click="increment">ç‚¹æˆ‘</button>
    </div>
  </div>
</template>

<style lang="less" scoped>
  .box-styl {
    margin: 10px;
    .section-box {
      margin: 20px auto;
      width: 300px;
      background-color: #d7ffed;
      border: 1px solid #000;
    }
  }
</style>
```

- Piniaåœ¨setupæ¨¡å¼ä¸‹çš„è°ƒç”¨æœºåˆ¶æ˜¯**å…ˆinstallå†è°ƒç”¨**ã€‚
- installè¿™æ ·å†™ï¼š `const counterStoreForSetup = useCounterStoreForSetup();`ï¼Œå…¶ä¸­ `useCounterStoreForSetup`å°±æ˜¯ä½ å®šä¹‰storeçš„å˜é‡ï¼›
- è°ƒç”¨å°±ç›´æ¥ç”¨ `counterStoreForSetup.xxx`ï¼ˆxxxåŒ…æ‹¬ï¼šstateã€gettersã€actionï¼‰å°±å¥½ã€‚
- ä»£ç ä¸­è·å–stateæ˜¯ç”¨äº†è§£æ„èµ‹å€¼ï¼Œä¸ºäº†ä¿æŒstateçš„å“åº”å¼ç‰¹æ€§ï¼Œéœ€è¦ç”¨`storeToRefs`è¿›è¡ŒåŒ…è£¹ã€‚

> å…¼å®¹Vue2çš„Options APIè°ƒç”¨æ–¹å¼å¯ä»¥åˆ° [è¿™é‡Œ](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJohnnyZhangQiao%2Fpinia-use%2Fblob%2Fmaster%2Fsrc%2Fcomponents%2FPiniaBasicOptions.vue)ã€‚

#### 5. è‰¯å¥½çš„ç¼–ç¨‹ä¹ æƒ¯

**stateçš„æ”¹å˜äº¤ç»™actionå»å¤„ç†ï¼š** ä¸Šé¢ä¾‹å­ï¼Œ`counterStoreForSetup`æœ‰ä¸ªpiniaå®ä¾‹å±æ€§å«`$state`æ˜¯å¯ä»¥ç›´æ¥æ”¹å˜stateçš„å€¼ï¼Œä½†ä¸å»ºè®®æ€ä¹ˆåšã€‚ä¸€æ˜¯éš¾ç»´æŠ¤ï¼Œåœ¨ç»„ä»¶ç¹å¤šæƒ…å†µä¸‹ï¼Œä¸€å¤„éšè”½stateæ›´æ”¹ï¼Œæ•´ä¸ªå¼€å‘ç»„å¸®ä½ æ’æŸ¥ï¼›äºŒæ˜¯ç ´åstoreå°è£…ï¼Œéš¾ä»¥ç§»æ¤åˆ°å…¶ä»–åœ°æ–¹ã€‚æ‰€ä»¥ï¼Œä¸ºäº†ä½ çš„å£°èª‰å’Œå®‰å…¨ç€æƒ³ï¼Œè¯·åœæ­¢æ¸¸ç¦»ä¹‹å¤–çš„codingğŸ˜‡ğŸ˜‡ã€‚

**ç”¨hookä»£æ›¿piniaå®ä¾‹å±æ€§ï¼š** installåçš„`counterStoreForSetup`å¯¹è±¡é‡Œé¢ï¼Œå¸¦æœ‰ä¸å°‘`$`å¼€å¤´çš„æ–¹æ³•ï¼Œå…¶å®è¿™äº›æ–¹æ³•å¤§å¤šæ•°éƒ½èƒ½é€šè¿‡hookå¼•å…¥ä»£æ›¿ã€‚

### ä¼ä¸šé¡¹ç›®å°è£…æ”»ç•¥

#### 1. å…¨å±€æ³¨å†Œæœº

##### é‡å¤æ‰“åŒ…é—®é¢˜

åœ¨ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œä½¿ç”¨storeæ—¶è¦å…ˆæŠŠstoreçš„å®šä¹‰importè¿›æ¥ï¼Œå†æ‰§è¡Œå®šä¹‰å‡½æ•°ä½¿å¾—å®ä¾‹åŒ–ã€‚ä½†æ˜¯ï¼Œåœ¨é¡¹ç›®é€æ¸åºå¤§èµ·æ¥åï¼Œæ¯ä¸ªç»„ä»¶è¦ä½¿ç”¨æ—¶å€™éƒ½è¦å®ä¾‹åŒ–å—ï¼Ÿåœ¨æ–‡ä¸­å¼€å¤´è®²è¿‡ï¼Œpiniaçš„ä»£ç åˆ†å‰²æœºåˆ¶æ˜¯æŠŠå¼•ç”¨å®ƒçš„é¡µé¢åˆå¹¶æ‰“åŒ…ï¼Œé‚£åƒä¸‹é¢çš„ä¾‹å­å°±ä¼šæœ‰é—®é¢˜ï¼Œuserè¢«å¤šä¸ªé¡µé¢å¼•ç”¨ï¼Œæœ€åuser storeè¢«é‡å¤æ‰“åŒ…ã€‚

![image-20230618163601742](https://cdn.jsdelivr.net/gh/citccld/blogimage@main/img/202306181636768.png)

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å¼•å…¥ **â€å…¨å±€æ³¨å†Œâ€œ** çš„æ¦‚å¿µã€‚åšæ³•å¦‚ä¸‹ï¼š

##### åˆ›å»ºæ€»å…¥å£

åœ¨`src/store`ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªå…¥å£`index.ts`ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªæ³¨å†Œå‡½æ•°`registerStore()`ï¼Œå…¶ä½œç”¨æ˜¯æŠŠæ•´ä¸ªé¡¹ç›®çš„storeéƒ½æå‰æ³¨å†Œå¥½ï¼Œæœ€åæŠŠæ‰€æœ‰çš„storeå®ä¾‹æŒ‚åˆ°`appStore`é€ä¼ å‡ºå»ã€‚è¿™æ ·ä»¥åï¼Œåªè¦æˆ‘ä»¬åœ¨é¡¹ç›®ä»»ä½•ç»„ä»¶è¦ä½¿ç”¨piniaæ—¶ï¼Œåªè¦import appStoreè¿›æ¥ï¼Œå–å¯¹åº”çš„storeå®ä¾‹å°±è¡Œã€‚

```typescript
// src/store/index.ts
import { roleStore } from './roleStore';
import { useCounterStoreForSetup } from '@/store/counterForSetup';
import { useCounterStoreForOption } from '@/store/counterForOptions';

export interface IAppStore {
  roleStore: ReturnType<typeof roleStore>;
  useCounterStoreForSetup: ReturnType<typeof useCounterStoreForSetup>;
  useCounterStoreForOption: ReturnType<typeof useCounterStoreForOption>;
}

const appStore: IAppStore = {} as IAppStore;

/**
 * æ³¨å†ŒappçŠ¶æ€åº“
 */
export const registerStore = () => {
  appStore.roleStore = roleStore();
  appStore.useCounterStoreForSetup = useCounterStoreForSetup();
  appStore.useCounterStoreForOption = useCounterStoreForOption();
};

export default appStore;
```

##### æ€»çº¿æ³¨å†Œ

åœ¨`src/main.ts`é¡¹ç›®æ€»çº¿æ‰§è¡Œæ³¨å†Œæ“ä½œï¼š

```typescript
import { createApp } from 'vue';
import App from './App.vue';
import { createPinia } from 'pinia';
import { registerStore } from '@/store';

const app = createApp(App);

app.use(createPinia());
// æ³¨å†ŒpiniaçŠ¶æ€ç®¡ç†åº“
registerStore();

app.mount('#app');
```

ä¸šåŠ¡ç»„ä»¶å†…ç›´æ¥ä½¿ç”¨

```typescript
// src/components/PiniaBasicSetup.vue
<script setup lang="ts" name="component-PiniaBasicSetup">
import { storeToRefs } from 'pinia';
import appStore from '@/store';

// setup composition APIæ¨¡å¼
const { count } = storeToRefs(appStore.useCounterStoreForSetup);
const { increment, doubleCount } = appStore.useCounterStoreForSetup;
</script>

<template>
  <div class="box-styl">
    <h1>Setupæ¨¡å¼</h1>
    <p class="section-box">
      Piniaçš„state: count = <b>{{ count }}</b>
    </p>
    <p class="section-box">
      Piniaçš„getters: doubleCount() = <b>{{ doubleCount() }}</b>
    </p>
    <div class="section-box">
      <p>Piniaçš„action: increment()</p>
      <button @click="increment">ç‚¹æˆ‘</button>
    </div>
  </div>
</template>
```

##### æ‰“åŒ…è§£è€¦

åˆ°è¿™é‡Œè¿˜ä¸è¡Œï¼Œä¸ºäº†è®©`appStore`å®ä¾‹ä¸é¡¹ç›®è§£è€¦ï¼Œåœ¨æ„å»ºæ—¶è¦æŠŠ`appStore`æŠ½å–åˆ°å…¬å…±chunkï¼Œåœ¨`vite.config.ts`åšå¦‚ä¸‹é…ç½®

```typescript
export default defineConfig(({ command }: ConfigEnv) => {
  return {
    // ...å…¶ä»–é…ç½®
    
    build: {
      // ...å…¶ä»–é…ç½®
      
      rollupOptions: {
        output: {
          manualChunks(id) {
            // å°†piniaçš„å…¨å±€åº“å®ä¾‹æ‰“åŒ…è¿›vendorï¼Œé¿å…å’Œé¡µé¢ä¸€èµ·æ‰“åŒ…é€ æˆèµ„æºé‡å¤å¼•å…¥
            if (id.includes(path.resolve(__dirname, '/src/store/index.ts'))) {
              return 'vendor';
            }
          }
        }
      }
    }
  };
});
```

ç»è¿‡è¿™æ ·å°è£…åï¼ŒpiniaçŠ¶æ€åº“å¾—åˆ°è§£è€¦ï¼Œæœ€ç»ˆçš„é¡¹ç›®ç»“æ„å›¾æ˜¯è¿™æ ·çš„ï¼š

























